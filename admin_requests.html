<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>إدارة طلبات التعديل - المدير</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #e74c3c; margin-top: 0; }
    .filters { margin: 20px 0; }
    select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: right; font-size: 14px; }
    th { background-color: #f2f2f2; }
    .action-btn { 
      padding: 6px 12px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      margin: 2px;
      font-weight: bold;
    }
    .view-btn { background: #3498db; color: white; }
    .status-Pending { background: #f39c12; color: white; }
    .status-Approved { background: #2ecc71; color: white; }
    .status-Rejected { background: #e74c3c; color: white; }
    .loading { text-align: center; padding: 40px; color: #777; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 2% auto; padding: 25px; width: 90%; max-width: 900px; border-radius: 8px; max-height: 95vh; overflow-y: auto; }
    .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
    .old-data, .new-data { padding: 15px; border-radius: 6px; }
    .old-data { background: #fbecec; border: 1px solid #e74c3c; }
    .new-data { background: #e8f8f5; border: 1px solid #2ecc71; }
    .comparison-grid h4 { margin-top: 0; }
    .notes-section { margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 6px; }
    .footer-actions { text-align: center; margin-top: 20px; }
    .footer-actions button { margin: 0 10px; padding: 10px 20px; font-size: 16px; }
    .approve-btn { background: #2ecc71; color: white; }
    .reject-btn { background: #e74c3c; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h2>مراجعة طلبات التعديل المعلقة</h2>
    
    <div class="filters">
      <select id="statusFilter" onchange="applyFilter()">
        <option value="Pending">الطلبات المعلقة فقط</option>
        <option value="">جميع الطلبات</option>
        <option value="Approved">الطلبات المقبولة</option>
        <option value="Rejected">الطلبات المرفوضة</option>
      </select>
    </div>

    <div id="requestsContainer">
      <div class="loading">جارٍ تحميل طلبات التعديل...</div>
    </div>
  </div>

  <div id="comparisonModal" class="modal">
    <div class="modal-content">
      <h3>مقارنة طلب التعديل (<span id="modal-request-id"></span>)</h3>
      <p>
        <strong>مقدم الطلب:</strong> <span id="modal-requester-name"></span> (<span id="modal-requester-id"></span>) | 
        <strong>دور مقدم الطلب:</strong> <span id="modal-requester-role"></span> |
        <strong>تاريخ الطلب:</strong> <span id="modal-request-date"></span>
      </p>

      <div class="notes-section">
        <h4>ملاحظات مقدم الطلب:</h4>
        <p id="modal-notes"></p>
      </div>

      <div class="comparison-grid">
        <div class="old-data">
          <h4>البيانات الأصلية الحالية في النظام (قبل التعديل)</h4>
          <div id="old-values"></div>
        </div>
        <div class="new-data">
          <h4>البيانات المطلوبة للتعديل</h4>
          <div id="new-values"></div>
        </div>
      </div>
      
      <div id="modal-status-display" style="text-align:center; margin-top:20px; font-weight:bold; font-size:1.2em;"></div>

      <div class="footer-actions">
        <button id="approveButton" class="action-btn approve-btn" onclick="approveRequest(currentRequestId)">قبول الطلب وتطبيق التعديلات</button>
        <button id="rejectButton" class="action-btn reject-btn" onclick="rejectRequest(currentRequestId)">رفض الطلب</button>
        <button class="action-btn" onclick="closeModal()">إغلاق</button>
      </div>
    </div>
  </div>

  <script>
    // ✅ الروابط المصححة بدون مسافات أو أحرف تالفة
    const SUPABASE_URL = 'https://akjyrmmqsnxdbkslxmvb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFranlybW1xc254ZGJrc2x4bXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4ODUxODcsImV4cCI6MjA4MDQ2MTE4N30.EuTd_i9fEecFGJG89PhRa3z68k5x6nflOW6fvqvMQJM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allRequests = [];
    let loggedInUser = {};
    let currentRequestId = null;

    async function init() {
      const userId = localStorage.getItem('loggedInUserId');
      if (!userId) {
        alert("الرجاء تسجيل الدخول أولًا!");
        window.location.href = "index.html";
        return;
      }

      const { data: user, error: userError } = await supabase
        .from('users')
        .select('role, full_name, id')
        .eq('id', userId)
        .single();

      if (userError || !user) {
        alert("حدث خطأ في تحميل بيانات المستخدم.");
        window.location.href = "index.html";
        return;
      }

      loggedInUser = user;

      // ✅ التحقق من أن المستخدم مدير
      if (loggedInUser.role !== 'admin') {
        alert("ليس لديك صلاحية الوصول إلى هذه الصفحة.");
        window.location.href = "index.html";
        return;
      }
      
      await loadRequests();
    }

    async function loadRequests() {
      document.getElementById('requestsContainer').innerHTML = '<div class="loading">جارٍ تحميل طلبات التعديل...</div>';

      const { data, error } = await supabase
        .from('edit_requests')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('requestsContainer').innerHTML = `<div class="status-Rejected">خطأ: ${error.message}</div>`;
        return;
      }

      allRequests = data;
      applyFilter();
    }

    function applyFilter() {
      const status = document.getElementById('statusFilter').value;
      let filtered = allRequests;

      if (status) {
        filtered = allRequests.filter(r => r.status === status);
      }
      renderTable(filtered);
    }

    function renderTable(data) {
      if (!data || data.length === 0) {
        document.getElementById('requestsContainer').innerHTML = '<div class="loading">لا توجد طلبات تعديل.</div>';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>رقم الطلب</th>
              <th>رقم العملية</th>
              <th>مقدم الطلب</th>
              <th>دور مقدم الطلب</th>
              <th>تاريخ الطلب</th>
              <th>الحالة</th>
              <th>الإجراء</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.forEach(row => {
        const statusText = 
          row.status === 'Pending' ? 'معلق' :
          row.status === 'Approved' ? 'مقبول' : 'مرفوض';
        
        html += `
          <tr>
            <td>${row.id}</td>
            <td>${row.operation_id}</td>
            <td>${row.requested_by}</td>
            <td>${row.requester_role || 'غير محدد'}</td>
            <td>${new Date(row.created_at).toLocaleDateString('ar-EG')}</td>
            <td><span class="action-btn status-${row.status}">${statusText}</span></td>
            <td>
              <button class="action-btn view-btn" onclick="openComparisonModal(${row.id})">مقارنة</button>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      document.getElementById('requestsContainer').innerHTML = html;
    }
    
    function openComparisonModal(requestId) {
      const request = allRequests.find(r => r.id === requestId);
      if (!request) return;

      currentRequestId = requestId;

      document.getElementById('modal-request-id').textContent = request.id;
      document.getElementById('modal-requester-name').textContent = request.requested_by;
      document.getElementById('modal-requester-id').textContent = request.requester_id;
      document.getElementById('modal-requester-role').textContent = request.requester_role || 'غير محدد';
      document.getElementById('modal-request-date').textContent = new Date(request.created_at).toLocaleString('ar-EG');
      document.getElementById('modal-notes').textContent = request.notes || 'لا توجد ملاحظات';
      
      renderComparisonData(request.old_value, 'old-values');
      renderComparisonData(request.new_value, 'new-values');

      const statusDisplay = document.getElementById('modal-status-display');
      const approveBtn = document.getElementById('approveButton');
      const rejectBtn = document.getElementById('rejectButton');
      
      statusDisplay.className = `status-${request.status}`;
      
      if (request.status === 'Pending') {
        statusDisplay.textContent = 'الحالة: معلق - مطلوب مراجعة';
        statusDisplay.style.color = '#f39c12';
        approveBtn.style.display = 'inline-block';
        rejectBtn.style.display = 'inline-block';
      } else if (request.status === 'Approved') {
        statusDisplay.textContent = `الحالة: مقبول ✅`;
        statusDisplay.style.color = '#2ecc71';
        approveBtn.style.display = 'none';
        rejectBtn.style.display = 'none';
      } else {
        statusDisplay.textContent = `الحالة: مرفوض ❌`;
        statusDisplay.style.color = '#e74c3c';
        approveBtn.style.display = 'none';
        rejectBtn.style.display = 'none';
      }

      document.getElementById('comparisonModal').style.display = 'block';
    }
    
    function renderComparisonData(data, elementId) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';
      
      // إذا كانت البيانات نصًا، حاول تحويلها إلى JSON
      let dataObj = data;
      if (typeof data === 'string') {
        try {
          dataObj = JSON.parse(data);
        } catch (e) {
          dataObj = { 'البيانات': data };
        }
      }
      
      // إذا كانت البيانات object، اعرضها
      if (typeof dataObj === 'object' && dataObj !== null) {
        for (const key in dataObj) {
          if (dataObj.hasOwnProperty(key)) {
            const p = document.createElement('p');
            const value = dataObj[key];
            p.innerHTML = `<strong>${key}:</strong> ${value === null || value === undefined ? '—' : value}`;
            container.appendChild(p);
          }
        }
      } else {
        container.innerHTML = '<p>لا توجد بيانات للمقارنة</p>';
      }
    }

    function closeModal() {
      document.getElementById('comparisonModal').style.display = 'none';
      currentRequestId = null;
    }
    
    async function approveRequest(requestId) {
      if (!confirm("هل أنت متأكد من قبول طلب التعديل وتطبيق التغييرات؟")) return;

      const request = allRequests.find(r => r.id === requestId);
      if (!request) {
        alert("لم يتم العثور على الطلب!");
        return;
      }
      
      try {
        // ✅ تأكد أن new_value هو object وليس string
        let newData = request.new_value;
        
        // إذا كان new_value نصًا، حوله إلى object
        if (typeof newData === 'string') {
          try {
            newData = JSON.parse(newData);
          } catch (e) {
            console.error('خطأ في تحويل JSON:', e);
            alert('خطأ في تنسيق البيانات. الرجاء التحقق من الطلب.');
            return;
          }
        }
        
        // ✅ تسجيل البيانات للتصحيح
        console.log('بيانات التحديث:', {
          operation_id: request.operation_id,
          newData: newData,
          keys: Object.keys(newData)
        });
        
        // ✅ تحديث جدول العمليات
        const { data: updateResult, error: updateError } = await supabase
          .from('operations')
          .update(newData)
          .eq('id', request.operation_id)
          .select();  // إضافة select لرؤية النتيجة

        if (updateError) {
          console.error('خطأ في تحديث العمليات:', updateError);
          throw new Error(`خطأ في تحديث العمليات: ${updateError.message}`);
        }

        if (!updateResult || updateResult.length === 0) {
          throw new Error('لم يتم تحديث أي سجل، ربما operation_id غير صحيح');
        }
        
        // ✅ تحديث حالة الطلب مع معلومات الموافقة
        const { error: statusError } = await supabase
          .from('edit_requests')
          .update({ 
            status: 'Approved',
            approved_by: loggedInUser.full_name,
            approved_at: new Date().toISOString(),
            notified: true
          })
          .eq('id', requestId);

        if (statusError) {
          console.error('خطأ في تحديث حالة الطلب:', statusError);
          throw statusError;
        }

        alert(`✅ تمت الموافقة على الطلب رقم ${requestId} وتطبيق التعديلات بنجاح.`);
        closeModal();
        await loadRequests();
      } catch (e) {
        console.error('حدث خطأ:', e);
        alert(`❌ فشل الموافقة: ${e.message}\n\nتحقق من وحدة التحكم (F12) للمزيد من التفاصيل.`);
      }
    }

    async function rejectRequest(requestId) {
      if (!confirm("هل أنت متأكد من رفض طلب التعديل؟")) return;

      try {
        const { error: statusError } = await supabase
          .from('edit_requests')
          .update({ 
            status: 'Rejected',
            approved_by: loggedInUser.full_name,
            approved_at: new Date().toISOString(),
            notified: true
          })
          .eq('id', requestId);

        if (statusError) {
          console.error('خطأ في تحديث حالة الطلب:', statusError);
          throw statusError;
        }

        alert(`✅ تم رفض الطلب رقم ${requestId}.`);
        closeModal();
        await loadRequests();
      } catch (e) {
        console.error('حدث خطأ:', e);
        alert("❌ حدث خطأ أثناء الرفض: " + e.message);
      }
    }

    window.onclick = function(event) {
      if (event.target.id === 'comparisonModal') closeModal();
    };

    init().catch(err => {
      console.error('خطأ:', err);
      document.getElementById('requestsContainer').innerHTML = `<div class="status-Rejected">خطأ في التحميل: ${err.message}</div>`;
    });
  </script>
</body>
</html>