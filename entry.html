<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="torrent" content="width=device-width, initial-scale=1.0"/>
  <title>إدخال بيانات العملية</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2, h3 {
      text-align: center;
      color: #2c3e50;
      margin-top: 0;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #34495e;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background: #2980b9;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: block;
      margin: 20px auto;
    }
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      text-align: center;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .preview-section { margin-top: 20px; }
    .preview-item {
      margin-bottom: 8px;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 14px;
    }
    .preview-label {
      font-weight: bold;
      color: #2c3e50;
    }
    .required::after { content: " *"; color: red; }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h2>إدخال البيانات</h2>
      <form id="entryForm">
        <div class="form-group">
          <label class="required">رقم البطاقة العميل</label>
          <input type="text" id="national_id" maxlength="14" minlength="14" required />
        </div>
        <div class="form-group">
          <label class="required">رقم بطاقة الضامن</label>
          <input type="text" id="guarantor_id" maxlength="14" minlength="14" required />
        </div>
        <div class="form-group">
          <label class="required">عدد أيام التأخير</label>
          <input type="number" id="days_delayed" value="0" min="0" required />
        </div>
        <div class="form-group">
          <label class="required">المشروع</label>
          <input type="text" id="project" required />
        </div>
        <div class="form-group">
          <label class="required">المبلغ المطلوب</label>
          <input type="number" id="requested_amount" min="1" required />
        </div>
        <div class="form-group">
          <label class="required">عدد الأقساط</label>
          <input type="number" id="installments" min="1" required />
        </div>
        <div class="form-group">
          <label class="required">اسم الأخصائي</label>
          <input type="text" id="officer" required />
        </div>
        <div class="form-group">
          <label class="required">المنطقة</label>
          <input type="text" id="region" required />
        </div>

        <div class="form-group" id="branchFieldContainer">
          <label class="required">الفرع</label>
          <div style="color: red;">جارٍ التحميل...</div>
        </div>

        <div class="form-group">
          <label class="required">رقم اللجنة</label>
          <input type="text" id="committee_number" required />
        </div>
        <div class="form-group">
          <label>القائم بالزيارة</label>
          <input type="text" id="visitor" />
        </div>
        <div class="form-group">
          <label class="required">اسم القائم بالإدخال</label>
          <input type="text" id="entry_by_display" readonly style="background:#f0f0f0;" />
        </div>
        <button type="submit">حفظ العملية</button>
        <div id="message"></div>
      </form>
    </div>

    <div class="panel">
      <h2>معاينة البيانات</h2>
      <div class="preview-section">
        <h3>بيانات العميل</h3>
        <div id="clientData">أدخل رقم بطاقة العميل لعرض البيانات</div>
      </div>
      <div class="preview-section">
        <h3>بيانات الضامن</h3>
        <div id="guarantorData">أدخل رقم بطاقة الضامن لعرض البيانات</div>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://akjyrmmqsnxdbkslxmvb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFranlybW1xc254ZGJrc2x4bXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4ODUxODcsImV4cCI6MjA4MDQ2MTE4N30.EuTd_i9fEecFGJG89PhRa3z68k5x6nflOW6fvqvMQJM'
    );

    window.onload = async () => {
      const userId = localStorage.getItem('loggedInUserId');
      const userFullName = localStorage.getItem('loggedInUser');
      
      if (!userId || !userFullName) {
        alert("الرجاء تسجيل الدخول أولًا!");
        window.location.href = "index.html";
        return;
      }

      document.getElementById('entry_by_display').value = userFullName;

      try {
        const { data, error } = await supabase
          .from('users')
          .select('branches')
          .eq('id', userId)
          .single();

        if (error || !data || !data.branches) {
          document.getElementById('branchFieldContainer').innerHTML = '<div style="color:red;">لا توجد فروع مرتبطة بحسابك</div>';
          return;
        }

        const branches = data.branches;
        const container = document.getElementById('branchFieldContainer');

        if (branches.length === 1) {
          container.innerHTML = `
            <label class="required">الفرع</label>
            <input type="text" id="branch" value="${branches[0]}" readonly style="background:#f0f0f0;" />
          `;
        } else {
          let options = branches.map(b => `<option value="${b}">${b}</option>`).join('');
          container.innerHTML = `
            <label class="required">الفرع</label>
            <select id="branch" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;">
              <option value="">اختر الفرع</option>
              ${options}
            </select>
          `;
        }
      } catch (err) {
        console.error("خطأ:", err);
        document.getElementById('branchFieldContainer').innerHTML = '<div style="color:red;">خطأ في تحميل الفروع</div>';
      }
    };

    // --- عرض بيانات العميل ---
    document.getElementById('national_id').addEventListener('blur', async () => {
      const nid = document.getElementById('national_id').value.trim();
      const div = document.getElementById('clientData');
      if (!nid) {
        div.innerHTML = "أدخل رقم بطاقة العميل لعرض البيانات";
        return;
      }

      try {
        const [loanRes, assessRes] = await Promise.all([
          supabase.from('loans').select('اسم العميل عربى, تاريخ القرض, اخصائى القرض, كود العميل, النشاط الثانى, "الفرع الحالى للعميل"').eq('الرقم القومى', nid).single(),
          supabase.from('assessments').select('الاسم, "السم المرسل من الاى سكور", "نتيجة التقييم", "سبب 2", "التقييم الرقمى", "احداثيات الموقع"').eq('رقم_البطاقة', nid).single()
        ]);

        let html = '';
        if (!loanRes.error && loanRes.data) {
          const l = loanRes.data;
          html += `<div class="preview-item"><span class="preview-label">اسم العميل:</span> ${l["اسم العميل عربى"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">تاريخ القرض:</span> ${l["تاريخ القرض"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">أخصائي القرض:</span> ${l["اخصائى القرض"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">كود العميل:</span> ${l["كود العميل"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">النشاط الثانى:</span> ${l["النشاط الثانى"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">الفرع الحالى:</span> ${l["الفرع الحالى للعميل"] || '—'}</div>`;
        } else {
          html += `<div class="preview-item">بيانات القرض: غير متوفرة</div>`;
        }

        html += `<hr style="margin: 10px 0;">`;

        if (!assessRes.error && assessRes.data) {
          const a = assessRes.data;
          html += `<div class="preview-item"><span class="preview-label">الاسم (تقييم):</span> ${a["الاسم"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">الاسم من الإي سكور:</span> ${a["السم المرسل من الاى سكور"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">نتيجة التقييم:</span> ${a["نتيجة التقييم"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">سبب 2:</span> ${a["سبب  2"] || a["سبب 2"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">التقييم الرقمى:</span> ${a["التقييم الرقمى"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">احداثيات الموقع:</span> ${a["احداثيات الموقع"] || '—'}</div>`;
        } else {
          html += `<div class="preview-item">بيانات التقييم: غير متوفرة</div>`;
        }
        div.innerHTML = html;
      } catch (err) {
        div.innerHTML = "حدث خطأ أثناء تحميل بيانات العميل";
        console.error(err);
      }
    });

    // --- عرض بيانات الضامن ---
    document.getElementById('guarantor_id').addEventListener('blur', async () => {
      const gid = document.getElementById('guarantor_id').value.trim();
      const div = document.getElementById('guarantorData');
      if (!gid) {
        div.innerHTML = "أدخل رقم بطاقة الضامن لعرض البيانات";
        return;
      }

      try {
        const { data, error } = await supabase
          .from('assessments')
          .select('الاسم, "السم المرسل من الاى سكور", "التقييم الرقمى", "نتيجة التقييم", "سبب 2"')
          .eq('رقم_البطاقة', gid)
          .single();

        let html = '';
        if (error) {
          html = `<div class="preview-item">رقم بطاقة الضامن: ${gid} (لا توجد بيانات)</div>`;
        } else {
          html += `<div class="preview-item"><span class="preview-label">الاسم:</span> ${data["الاسم"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">الاسم من الإي سكور:</span> ${data["السم المرسل من الاى سكور"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">التقييم الرقمى:</span> ${data["التقييم الرقمى"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">نتيجة التقييم:</span> ${data["نتيجة التقييم"] || '—'}</div>`;
          html += `<div class="preview-item"><span class="preview-label">سبب 2:</span> ${data["سبب  2"] || data["سبب 2"] || '—'}</div>`;
        }
        div.innerHTML = html;
      } catch (err) {
        div.innerHTML = "حدث خطأ أثناء تحميل بيانات الضامن";
        console.error(err);
      }
    });

    // --- حفظ البيانات ---
    document.getElementById('entryForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        "رقم البطاقة العميل": document.getElementById('national_id').value.trim(),
        "رقم بطاقة الضامن": document.getElementById('guarantor_id').value.trim(),
        "عدد ايام التاخير": parseInt(document.getElementById('days_delayed').value) || 0,
        "المشروع": document.getElementById('project').value.trim(),
        "المبلغ المطلوب": parseFloat(document.getElementById('requested_amount').value) || null,
        "عدد الاقساط": parseInt(document.getElementById('installments').value) || null,
        "اسم الاخصائى": document.getElementById('officer').value.trim(),
        "المنطقه": document.getElementById('region').value.trim(),
        "الفرع": document.getElementById('branch')?.value?.trim(),
        "رقم اللجنة": document.getElementById('committee_number').value.trim(),
        "القائم بالزياره": document.getElementById('visitor').value.trim() || null,
        "اسم القائم بالادخال": document.getElementById('entry_by_display').value.trim(),
        "المراجعة الداخلية": "لم تتم المراجعة",
        "مسؤول المتابعة": "لم تتم المراجعة",
        "الادارة": "لم تتم المراجعة",
        "تم التحويل": false,
        "created_by": document.getElementById('entry_by_display').value.trim()
      };

      if (!/^\d{14}$/.test(data["رقم البطاقة العميل"]) || !/^\d{14}$/.test(data["رقم بطاقة الضامن"])) {
        alert("الرجاء التأكد من أن رقم البطاقة مكون من 14 رقمًا");
        return;
      }
      if (!data["الفرع"]) {
        alert("الرجاء اختيار الفرع");
        return;
      }

      try {
        const { error } = await supabase.from('operations').insert([data]);
        if (error) throw error;

        // ✅ إظهار تنبيه ثم إعادة التحميل
        alert("تم الحفظ بنجاح!");
        window.location.reload(); // إعادة تحميل الصفحة بالكامل

      } catch (err) {
        alert("خطأ: " + (err.message || "فشل في الحفظ"));
      }
    });
  </script>
</body>
</html>