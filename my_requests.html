<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #3498db;
    }
    
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    select, input {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-width: 200px;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: right;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      text-align: right;
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
      text-align: center;
      min-width: 100px;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status-approved {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .view-btn {
      background: #3498db;
      color: white;
    }
    
    .view-btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }
    
    .no-data {
      text-align: center;
      padding: 50px;
      color: #7f8c8d;
      font-size: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .no-data i {
      font-size: 48px;
      color: #bdc3c7;
      margin-bottom: 15px;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f1f1;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #2c3e50;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #95a5a6;
      cursor: pointer;
      padding: 5px;
      transition: color 0.3s;
    }
    
    .close-btn:hover {
      color: #e74c3c;
    }
    
    .details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 25px;
      margin: 20px 0;
    }
    
    .detail-section {
      padding: 20px;
      border-radius: 8px;
      background: #f8f9fa;
    }
    
    .detail-section h4 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #2c3e50;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .detail-item {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .detail-label {
      font-weight: 600;
      color: #555;
      flex: 1;
    }
    
    .detail-value {
      flex: 2;
      text-align: left;
      color: #333;
    }
    
    .notes-section {
      background: #fff8e1;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #ffc107;
    }
    
    .comparison-section {
      margin: 25px 0;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    
    .old-data {
      background: #ffebee;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ffcdd2;
    }
    
    .new-data {
      background: #e8f5e8;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #c8e6c9;
    }
    
    .data-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    
    .data-item {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #ddd;
    }
    
    .data-key {
      font-weight: 600;
      color: #555;
      display: inline-block;
      width: 45%;
    }
    
    .data-value {
      color: #333;
      display: inline-block;
      width: 53%;
      text-align: left;
    }
    
    .change-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 8px;
      text-align: center;
      line-height: 20px;
      font-size: 12px;
    }
    
    .changed {
      background: #ff9800;
      color: white;
    }
    
    .unchanged {
      background: #bdbdbd;
      color: white;
    }
    
    .stats-bar {
      display: flex;
      justify-content: space-between;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    
    .stat-item {
      text-align: center;
      flex: 1;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
      margin-top: 5px;
    }
    
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      
      select, input {
        width: 100%;
      }
      
      .details-grid,
      .comparison-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 20px;
      }
      
      .stats-bar {
        flex-wrap: wrap;
      }
      
      .stat-item {
        flex: 0 0 50%;
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ</h2>
    
    <div class="filters">
      <select id="statusFilter" onchange="filterRequests()">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="Pending">Ù…Ø¹Ù„Ù‘Ù‚</option>
        <option value="Approved">Ù…Ù‚Ø¨ÙˆÙ„</option>
        <option value="Rejected">Ù…Ø±ÙÙˆØ¶</option>
      </select>
      
      <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„..." onkeyup="filterRequests()" />
    </div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="totalRequests">0</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="pendingRequests">0</div>
        <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="approvedRequests">0</div>
        <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ù‚Ø¨ÙˆÙ„Ø©</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="rejectedRequests">0</div>
        <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©</div>
      </div>
    </div>
    
    <div id="requestsTable">
      <div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...</div>
    </div>
  </div>

  <!-- Modal for Request Details -->
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… <span id="modalRequestId"></span></h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      
      <div class="details-grid">
        <div class="detail-section">
          <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h4>
          <div class="detail-item">
            <span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„:</span>
            <span class="detail-value" id="modalOperationId"></span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
            <span class="detail-value" id="modalStatus"></span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</span>
            <span class="detail-value" id="modalCreatedAt"></span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</span>
            <span class="detail-value" id="modalReviewedAt"></span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙˆØ§Ø³Ø·Ø©:</span>
            <span class="detail-value" id="modalReviewedBy"></span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h4>
          <div class="detail-item">
            <span class="detail-label">Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨:</span>
            <span class="detail-value" id="modalRequesterName"></span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Ø¯ÙˆØ± Ù…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨:</span>
            <span class="detail-value" id="modalRequesterRole"></span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨:</span>
            <span class="detail-value" id="modalRequestReason"></span>
          </div>
        </div>
      </div>
      
      <div class="notes-section">
        <h4>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h4>
        <p id="modalNotes"></p>
      </div>
      
      <div class="comparison-section">
        <h4>ğŸ”„ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</h4>
        <div class="comparison-grid">
          <div class="old-data">
            <div class="data-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
            <div id="modalOldData"></div>
          </div>
          <div class="new-data">
            <div class="data-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
            <div id="modalNewData"></div>
          </div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button class="action-btn view-btn" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://akjyrmmqsnxdbkslxmvb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFranlybW1xc254ZGJrc2x4bXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4ODUxODcsImV4cCI6MjA4MDQ2MTE4N30.EuTd_i9fEecFGJG89PhRa3z68k5x6nflOW6fvqvMQJM'
    );

    let allRequests = [];
    let currentUserId = null;

    async function init() {
      currentUserId = localStorage.getItem('loggedInUserId');
      if (!currentUserId) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");
        window.location.href = "index.html";
        return;
      }

      // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const { data: userData, error: userError } = await supabase
        .from('users')
        .select('full_name, role')
        .eq('id', currentUserId)
        .single();

      if (userError) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userError);
      }

      await loadMyRequests();
    }

    async function loadMyRequests() {
      document.getElementById('requestsTable').innerHTML = '<div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...</div>';

      const { data, error } = await supabase
        .from('edit_requests')
        .select('*')
        .eq('requester_id', currentUserId)
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('requestsTable').innerHTML = 
          '<div class="no-data">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message + '</div>';
        return;
      }

      allRequests = data;
      updateStats();
      renderTable(allRequests);
    }

    function updateStats() {
      const total = allRequests.length;
      const pending = allRequests.filter(r => r.status === 'Pending').length;
      const approved = allRequests.filter(r => r.status === 'Approved').length;
      const rejected = allRequests.filter(r => r.status === 'Rejected').length;

      document.getElementById('totalRequests').textContent = total;
      document.getElementById('pendingRequests').textContent = pending;
      document.getElementById('approvedRequests').textContent = approved;
      document.getElementById('rejectedRequests').textContent = rejected;
    }

    function renderTable(requests) {
      if (!requests || requests.length === 0) {
        document.getElementById('requestsTable').innerHTML = `
          <div class="no-data">
            ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ¹Ø¯ÙŠÙ„
            <p style="margin-top: 15px; color: #666; font-size: 14px;">
              ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨Ø§Øª ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø®Ù„Ø§Ù„ ØµÙØ­Ø© "Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„ÙŠØ©"
            </p>
          </div>
        `;
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody>
      `;

      requests.forEach(req => {
        const statusClass = req.status === 'Pending' ? 'status-pending' :
                          req.status === 'Approved' ? 'status-approved' : 'status-rejected';
        
        const statusText = req.status === 'Pending' ? 'â³ Ù…Ø¹Ù„Ù‘Ù‚' :
                          req.status === 'Approved' ? 'âœ… Ù…Ù‚Ø¨ÙˆÙ„' : 'âŒ Ù…Ø±ÙÙˆØ¶';
        
        const updatedAt = req.approved_at || req.updated_at || req.created_at;

        html += `
          <tr>
            <td><strong>#${req.id}</strong></td>
            <td>${req.operation_id}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${formatDate(req.created_at)}</td>
            <td>${formatDate(updatedAt)}</td>
            <td>
              <button class="action-btn view-btn" onclick="showDetails(${req.id})">
                Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
              </button>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      document.getElementById('requestsTable').innerHTML = html;
    }

    function filterRequests() {
      const statusFilter = document.getElementById('statusFilter').value;
      const searchText = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allRequests;

      if (statusFilter) {
        filtered = filtered.filter(req => req.status === statusFilter);
      }

      if (searchText) {
        filtered = filtered.filter(req => 
          req.id.toString().includes(searchText) ||
          req.operation_id.toString().includes(searchText) ||
          (req.notes && req.notes.toLowerCase().includes(searchText))
        );
      }

      renderTable(filtered);
    }

    function formatDate(dateString) {
      if (!dateString) return 'â€”';
      const date = new Date(dateString);
      return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    async function showDetails(requestId) {
      const request = allRequests.find(r => r.id === requestId);
      if (!request) return;

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      document.getElementById('modalRequestId').textContent = request.id;
      document.getElementById('modalOperationId').textContent = request.operation_id;
      document.getElementById('modalCreatedAt').textContent = formatDate(request.created_at);
      document.getElementById('modalReviewedAt').textContent = request.approved_at ? formatDate(request.approved_at) : 'â€”';
      document.getElementById('modalReviewedBy').textContent = request.approved_by || 'â€”';
      document.getElementById('modalRequesterName').textContent = request.requested_by || 'â€”';
      document.getElementById('modalRequesterRole').textContent = request.requester_role || 'â€”';
      document.getElementById('modalNotes').textContent = request.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª';
      
      // Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø®ØªØµØ± Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)
      const shortReason = request.notes ? 
        (request.notes.length > 100 ? request.notes.substring(0, 100) + '...' : request.notes) : 
        'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø³Ø¨Ø¨';
      document.getElementById('modalRequestReason').textContent = shortReason;

      // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚
      const statusMap = {
        'Pending': '<span class="status-pending">â³ Ù…Ø¹Ù„Ù‘Ù‚</span>',
        'Approved': '<span class="status-approved">âœ… Ù…Ù‚Ø¨ÙˆÙ„</span>',
        'Rejected': '<span class="status-rejected">âŒ Ù…Ø±ÙÙˆØ¶</span>'
      };
      document.getElementById('modalStatus').innerHTML = statusMap[request.status] || request.status;

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      displayComparisonData(request.old_value, 'modalOldData');
      displayComparisonData(request.new_value, 'modalNewData');

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      document.getElementById('detailsModal').style.display = 'block';
    }

    function displayComparisonData(data, elementId) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†ØµÙ‹Ø§
      let dataObj = data;
      if (typeof data === 'string') {
        try {
          dataObj = JSON.parse(data);
        } catch (e) {
          dataObj = { 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª': data };
        }
      }

      if (!dataObj || typeof dataObj !== 'object') {
        container.innerHTML = '<div class="data-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        return;
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      for (const [key, value] of Object.entries(dataObj)) {
        const div = document.createElement('div');
        div.className = 'data-item';
        
        const keySpan = document.createElement('span');
        keySpan.className = 'data-key';
        keySpan.textContent = key + ':';
        
        const valueSpan = document.createElement('span');
        valueSpan.className = 'data-value';
        valueSpan.textContent = value === null || value === undefined ? 'â€”' : value;
        
        div.appendChild(keySpan);
        div.appendChild(valueSpan);
        container.appendChild(div);
      }

      if (Object.keys(dataObj).length === 0) {
        container.innerHTML = '<div class="data-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
      }
    }

    function closeModal() {
      document.getElementById('detailsModal').style.display = 'none';
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    window.onclick = function(event) {
      const modal = document.getElementById('detailsModal');
      if (event.target === modal) {
        closeModal();
      }
    };

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ù…ÙØªØ§Ø­ ESC
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeModal();
      }
    });

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    init().catch(error => {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
      document.getElementById('requestsTable').innerHTML = 
        '<div class="no-data">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.</div>';
    });
  </script>
</body>
</html>