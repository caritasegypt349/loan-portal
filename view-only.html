<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 20px; min-height: 100vh; }
    .container { max-width: 1900px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    h2 { text-align: center; color: #2c3e50; font-size: 28px; margin-bottom: 10px; }
    
    /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
    .stats { display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border-radius: 8px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .stat-card .value { font-size: 24px; font-weight: bold; }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„ÙÙ„Ø§ØªØ± */
    .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    select, input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; }
    
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #e0e0e0; padding: 10px 5px; text-align: right; font-size: 12px; }
    th { background: #764ba2; color: white; position: sticky; top: 0; }
    
    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø© */
    .approved-cell { background-color: #e6ffe6 !important; color: #008000; font-weight: bold; }
    .rejected-cell { background-color: #ffe6e6 !important; color: #cc0000; font-weight: bold; }
    
    /* Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ */
    .detail-row { display: none; background: #f0f4f8; }
    .detail-container { padding: 20px; }
    .detail-row-sections { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .detail-section h3 { color: #764ba2; font-size: 16px; border-bottom: 2px solid #764ba2; padding-bottom: 5px; margin-bottom: 10px; }
    .detail-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; border-bottom: 1px solid #eee; }
    .detail-label { font-weight: bold; color: #2c3e50; }
    
    .expand-btn { background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .loading { text-align: center; padding: 50px; font-size: 20px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h2>

    <div class="stats">
      <div class="stat-card"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div><div class="value" id="totalRecords">0</div></div>
      <div class="stat-card"><div class="label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div><div class="value" id="totalAmount">0</div></div>
    </div>

    <div class="filters">
      <input type="text" id="searchClient" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„...">
      <select id="filterBranch"><option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option></select>
      <select id="filterReview"><option value="">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option></select>
      <button onclick="location.reload()" style="background:#95a5a6; color:white; border:none; border-radius:6px; cursor:pointer;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <div class="table-wrapper" id="tableContent">
      <div class="loading">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>
  </div>

  <script>
    (function() {
      "use strict";
      const S_URL = 'https://akjyrmmqsnxdbkslxmvb.supabase.co';
      const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFranlybW1xc254ZGJrc2x4bXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4ODUxODcsImV4cCI6MjA4MDQ2MTE4N30.EuTd_i9fEecFGJG89PhRa3z68k5x6nflOW6fvqvMQJM';
      const _db = window.supabase.createClient(S_URL, S_KEY);

      let allData = [];
      const userBranches = JSON.parse(localStorage.getItem('userBranches') || "[]");
      const userRole = localStorage.getItem('userRole');

      async function fetchData() {
        try {
          let query = _db.from('operations_with_details').select('*');
          if (userRole !== 'admin' && userRole !== 'followup_supervisor' && userBranches.length > 0) {
            query = query.in('Ø§Ù„ÙØ±Ø¹', userBranches);
          }
          const { data, error } = await query.order('created_at', { ascending: false });
          if (error) throw error;
          allData = data;
          
          // Ù…Ù„Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ±
          const branches = [...new Set(data.map(i => i["Ø§Ù„ÙØ±Ø¹"]))];
          const branchSel = document.getElementById('filterBranch');
          branches.forEach(b => { if(b) branchSel.innerHTML += `<option value="${b}">${b}</option>`; });

          renderTable(data);
          updateStats(data);
        } catch (e) {
          document.getElementById('tableContent').innerHTML = `<div style="color:red; text-align:center;">Ø®Ø·Ø£: ${e.message}</div>`;
        }
      }

      function renderTable(data) {
        const container = document.getElementById('tableContent');
        let html = `<table><thead><tr>
          <th>#</th><th>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
          <th>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¶Ø§Ù…Ù†</th><th>Ø§Ø³Ù… Ø§Ù„Ø¶Ø§Ù…Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ</th>
          <th>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th><th>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</th><th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th><th>Ø§Ù„Ù„Ø¬Ù†Ø©</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
        </tr></thead><tbody>`;

        data.forEach((row, idx) => {
          const rClass = (row["Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©"] || "").includes("Ù…Ù‚Ø¨ÙˆÙ„") ? "approved-cell" : (row["Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©"] || "").includes("Ù…Ø±ÙÙˆØ¶") ? "rejected-cell" : "";
          const sClass = (row["Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"] || "").includes("Ù…Ù‚Ø¨ÙˆÙ„") ? "approved-cell" : (row["Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"] || "").includes("Ù…Ø±ÙÙˆØ¶") ? "rejected-cell" : "";

          html += `
            <tr>
              <td>${idx + 1}</td>
              <td>${row["Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„"] || 'â€”'}</td>
              <td>${row["ÙƒÙˆØ¯_Ø§Ù„Ø¹Ù…ÙŠÙ„"] || 'â€”'}</td>
              <td>${row["Ø§Ø³Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„"] || row["Ø§Ø³Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„_Ù…Ù†_Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"] || 'â€”'}</td>
              <td>${row["Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"] || 'â€”'}</td>
              <td>${row["Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¶Ø§Ù…Ù†"] || 'â€”'}</td>
              <td>${row["Ø§Ø³Ù…_Ø§Ù„Ø¶Ø§Ù…Ù†"] || 'â€”'}</td>
              <td style="font-weight:bold; color:#667eea;">${row["Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"] || 0}</td>
              <td>${row["Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØµØ§Ø¦Ù‰"] || 'â€”'}</td>
              <td class="${rClass}">${row["Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©"] || 'â€”'}</td>
              <td class="${sClass}">${row["Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"] || 'â€”'}</td>
              <td>${row["Ø§Ù„Ø§Ø¯Ø§Ø±Ø©"] || 'â€”'}</td>
              <td>${row["Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø©"] || 'â€”'}</td>
              <td><button class="expand-btn" onclick="toggleRow(${idx})">Ø¹Ø±Ø¶</button></td>
            </tr>
            <tr class="detail-row" id="row-${idx}">
              <td colspan="14">
                <div class="detail-container">
                  <div class="detail-row-sections">
                    <div class="detail-section">
                      <h3>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
                      <div class="detail-item"><span class="detail-label">Ø§Ù„ÙØ±Ø¹:</span> <span>${row["Ø§Ù„ÙØ±Ø¹"]}</span></div>
                      <div class="detail-item"><span class="detail-label">Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±:</span> <span>${row["Ø¹Ø¯Ø¯ Ø§ÙŠØ§Ù… Ø§Ù„ØªØ§Ø®ÙŠØ±"]}</span></div>
                      <div class="detail-item"><span class="detail-label">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</span> <span style="font-size:9px;">${row["Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹"]}</span></div>
                    </div>
                    <div class="detail-section">
                      <h3>ğŸ“Š ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                      <div class="detail-item"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</span> <span>${row["Ø±Ù‚Ù…_Ø§Ù„Ø­Ø³Ø§Ø¨_Ù…Ù†_Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"]}</span></div>
                      <div class="detail-item"><span class="detail-label">Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</span> <span>${row["Ù†ØªÙŠØ¬Ø©_Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"]}</span></div>
                      <div class="detail-item"><span class="detail-label">ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…:</span> <span>${row["ØªØ¹Ù„ÙŠÙ‚_Ø§Ø³ØªØ¹Ù„Ø§Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„"]}</span></div>
                    </div>
                    <div class="detail-section">
                      <h3>ğŸ‘¥ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¶Ø§Ù…Ù†</h3>
                      <div class="detail-item"><span class="detail-label">Ø§Ø³Ù… Ø§Ù„Ø¶Ø§Ù…Ù† I-Score:</span> <span>${row["Ø§Ø³Ù…_Ø§Ù„Ø¶Ø§Ù…Ù†_Ù…Ù†_Ø§Ù„Ø§ÙŠ_Ø³ÙƒÙˆØ±"]}</span></div>
                      <div class="detail-item"><span class="detail-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠ:</span> <span>${row["ØªÙ‚ÙŠÙŠÙ…_Ø±Ù‚Ù…Ù‰_Ø§Ù„Ø¶Ø§Ù…Ù†"]}</span></div>
                    </div>
                    <div class="detail-section">
                      <h3>âœ… Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
                      <div class="detail-item"><span class="detail-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</span> <span>${row["Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©"]}</span></div>
                      <div class="detail-item"><span class="detail-label">ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</span> <span>${row["ØªØ¹Ù„ÙŠÙ‚ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"]}</span></div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
      }

      window.toggleRow = (idx) => {
        const row = document.getElementById(`row-${idx}`);
        row.style.display = (row.style.display === 'table-row') ? 'none' : 'table-row';
      };

      function updateStats(data) {
        document.getElementById('totalRecords').textContent = data.length;
        const total = data.reduce((s, r) => s + (parseFloat(r["Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"]) || 0), 0);
        document.getElementById('totalAmount').textContent = total.toLocaleString() + " Ø¬.Ù…";
      }

      fetchData();
    })();
  </script>
</body>
</html>